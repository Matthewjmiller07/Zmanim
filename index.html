<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Advanced Zmanim Lookup</title>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f0f4f8;
                color: #333;
            }
            h1, h2 {
                color: #2c3e50;
                text-align: center;
            }
            form, #results, #chart-container {
                background-color: #ffffff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input, button, select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #2980b9;
            }
            .zman-item {
                margin-bottom: 10px;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .zman-name {
                font-weight: bold;
                color: #2c3e50;
            }
            .zman-time {
                color: #34495e;
            }
            #zmanim-select {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }
            .zman-checkbox {
                display: flex;
                align-items: center;
            }
            .zman-checkbox input {
                margin-right: 5px;
                width: auto;
            }
            #cities-container {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            .city-input {
                flex: 1;
            }
            .select-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }
            .select-buttons button {
                flex: 1;
            }
            #chart-container {
                height: 400px;
            }
        </style>
    </head>
<body>
    <h1>Advanced Zmanim Lookup</h1>
    <form id="zmanim-form">
        <div id="cities-container">
            <div class="city-input">
                <input type="text" placeholder="Enter city name" required>
                <button type="button" class="remove-city" style="display:none;">Remove</button>
            </div>
        </div>
        <button type="button" id="add-city">Add City</button>
        <div class="form-group">
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" required>
        </div>
        <div class="form-group">
            <label for="end-date">End Date:</label>
            <input type="date" id="end-date" required>
        </div>
        <div class="form-group">
            <label>Select Zmanim:</label>
            <div class="select-buttons">
                <button type="button" id="select-all">Select All</button>
                <button type="button" id="deselect-all">Deselect All</button>
            </div>
            <div id="zmanim-select"></div>
        </div>
        <button type="submit">Get Zmanim</button>
    </form>
    <div id="results"></div>
    <div id="chart-container">
        <div id="zmanim-chart"></div>
    </div>

    <script>
        const zmanim = [
            "sunrise", "sunset", "dawn", "dusk", "chatzot", "alotHaShachar", "misheyakir", "sofZmanShma", 
            "sofZmanTfilla", "minchaGedola", "minchaKetana", "plagHaMincha", "tzeit", "tzeis", "tzait",
            "tzeit7083deg", "tzeis72min", "tzeitHakochavim", "candleLighting", "havdalah"
        ];

        function populateZmanimCheckboxes() {
            const container = document.getElementById('zmanim-select');
            zmanim.forEach(zman => {
                const checkbox = document.createElement('div');
                checkbox.className = 'zman-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="${zman}" name="zmanim" value="${zman}">
                    <label for="${zman}">${formatZmanName(zman)}</label>
                `;
                container.appendChild(checkbox);
            });
        }

        populateZmanimCheckboxes();

        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('input[name="zmanim"]').forEach(cb => cb.checked = true);
        });

        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('input[name="zmanim"]').forEach(cb => cb.checked = false);
        });

        document.getElementById('add-city').addEventListener('click', () => {
            const citiesContainer = document.getElementById('cities-container');
            const newCity = document.createElement('div');
            newCity.className = 'city-input';
            newCity.innerHTML = `
                <input type="text" placeholder="Enter city name" required>
                <button type="button" class="remove-city">Remove</button>
            `;
            citiesContainer.appendChild(newCity);
            newCity.querySelector('.remove-city').addEventListener('click', () => {
                citiesContainer.removeChild(newCity);
            });
        });

        document.getElementById('zmanim-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cities = Array.from(document.querySelectorAll('#cities-container input')).map(input => input.value);
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);
            const resultsDiv = document.getElementById('results');

            resultsDiv.innerHTML = '<p>Loading...</p>';

            try {
                const zmanimData = await Promise.all(cities.map(city => fetchZmanimForDateRange(city, startDate, endDate, selectedZmanim)));
                displayResults(zmanimData, cities, startDate, endDate);
                createChart(zmanimData, cities, startDate, endDate, selectedZmanim);
            } catch (error) {
                resultsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        });

        async function fetchZmanimForDateRange(city, startDate, endDate, selectedZmanim) {
    const params = new URLSearchParams({
        cfg: 'json',
        city: city,
        start: startDate,
        end: endDate,
        b: ' 18',
        M: 'on',
        m: '50'
    });

    const response = await fetch(`https://www.hebcal.com/zmanim?${params}`);
    const data = await response.json();
    console.log('Raw Zmanim Data:', data); // Debugging output
    return data;
}

function displayResults(zmanimData, cities, startDate, endDate) {
    const selectedZmanim = Array.from(document.querySelectorAll('input[name="zmanim"]:checked')).map(cb => cb.value);
    const resultsDiv = document.getElementById('results');
    let html = `<h2>Zmanim Comparison (${startDate} to ${endDate})</h2>`;

    cities.forEach((city, index) => {
        const cityData = zmanimData[index];
        html += `<h3>${city}</h3>`;

        if (cityData && cityData.times) {
            const times = cityData.times;
            let cityHtml = '<ul>';

            Object.entries(times).forEach(([zman, dateTimes]) => {
                if (selectedZmanim.includes(zman) && dateTimes) {
                    Object.entries(dateTimes).forEach(([date, time]) => {
                        if (time) {
                            const formattedTime = new Date(time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            cityHtml += `<li>${formatZmanName(zman)} (${date}): ${formattedTime}</li>`;
                        } else {
                            console.warn(`No valid time for ${zman} on ${date} in ${city}`);
                        }
                    });
                }
            });

            cityHtml += '</ul>';
            html += cityHtml;
        } else {
            html += '<p>No data available for this city.</p>';
        }
    });

    resultsDiv.innerHTML = html;
}

function createChart(zmanimData, cities, startDate, endDate, selectedZmanim) {
    const series = [];

    selectedZmanim.forEach(zman => {
        cities.forEach((city, cityIndex) => {
            const data = [];
            const cityData = zmanimData[cityIndex];
            if (cityData.times[zman]) {
                Object.entries(cityData.times[zman]).forEach(([date, time]) => {
                    if (time) {
                        const parsedDate = new Date(date + 'T00:00:00'); // Parse the date only
                        const zmanTime = new Date(time);
                        const timeInHours = zmanTime.getHours() + zmanTime.getMinutes() / 60;
                        data.push([parsedDate.getTime(), timeInHours]);
                    }
                });
            }

            series.push({
                name: `${formatZmanName(zman)} - ${city}`,
                data: data.sort((a, b) => a[0] - b[0]) // Ensure data is sorted by date
            });
        });
    });

    const options = {
        chart: {
            type: 'line',
            height: 400,
            toolbar: {
                show: true
            }
        },
        series: series,
        xaxis: {
            type: 'datetime',
            title: {
                text: 'Date'
            },
            labels: {
                format: 'yyyy-MM-dd' // Show date on the x-axis
            }
        },
        yaxis: {
            title: {
                text: 'Time (hours)'
            },
            labels: {
                formatter: function(value) {
                    return value.toFixed(2); // Format hours with two decimal places
                }
            }
        },
        stroke: {
            curve: 'smooth'
        },
        markers: {
            size: 4
        },
        tooltip: {
            x: {
                format: 'yyyy-MM-dd' // Show full date in tooltip
            },
            y: {
                formatter: function(value) {
                    const hours = Math.floor(value);
                    const minutes = Math.round((value - hours) * 60);
                    return `${hours}h ${minutes}m`;
                }
            }
        }
    };

    const chart = new ApexCharts(document.querySelector("#zmanim-chart"), options);
    chart.render();
}

        function formatZmanName(zman) {
            return zman
                .replace(/([A-Z])/g, ' $1')
                .split(/(?=[A-Z])/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ')
                .trim();
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>
</html>
